---
title: "Final Project"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source: https://github.com/dwfainstein/Final_proj_edld652
---

```{r setup, include=FALSE}
# install.packages("mapcan")
# you will probably need to install this package is specific to choropleths for Canada
library(flexdashboard)
library(here)
library(readxl)
library(mapcan)
library(tidyverse)
library(janitor)
library(shiny)
library(plotly)
library(stringr)
```

``` {r prep}
composition_data <- read_excel(here("data", "class_size_composition.xlsx")) %>% 
  filter(DATA_LEVEL == "DISTRICT LEVEL",
         GRADE_GROUP == "All Grades")

districting <- read_excel(here("data", "DataVizfinal_names.xlsx")) %>% 
  select(SD,
         DISTRICT_NAME,
         riding_name_english,
         Code) %>% 
  full_join(composition_data, by = "DISTRICT_NAME") %>% 
  rename(riding_code = Code)

districting$SCHOOL_YEAR <- str_sub(districting$SCHOOL_YEAR, 6)

```
##Hi Dave, your ggplot skill is way more advanced than mine. So, I don't have any suggestions for the coding. The comments I can give would be from an audience's perspective. I leave my comments right under each chunk of the graph.

##One thing I learned from your script is that I am more familiar with interactive ggplot. I gotta learn more for my own final project, though.

##Three strengths of in your project are 1) They are interactive!; 2) It has tabs on the flexdashboard, which is really user-friendly; and 3) You've provided descriptions about your data. It is really helpful for people outside the field of Education.

Individualized Education Programs in BC
===============================
Column {data-width=350}
----------------------
### Number of K-12 Classes with at least Three Students with IEPs by District in BC

This is an interactive figure which indicates the amount of classrooms in each district that are composed of at least three students with individualized education plans. This is important because three IEPs in one classroom is the minimum threshold for additional supports to be put in place for classroom teachers in supporting students with accommodations and modifications. Future iterations of this figure may demonstrate
this relationship over time for the province of BC.

```{r setMap}
BC_data <- mapcan::census_pop2016 %>% 
  select(population_2016,
         pr_english,
         population_density_2016,
         born_outside_canada,
         census_division_name) %>% 
  filter(pr_english == "British Columbia") %>% 
    mapcan(boundaries = ridings,
          type = standard,
          province = BC)

IEPex1 <- districting %>% 
  filter(SCHOOL_YEAR == "2020") %>% 
  select( NUMBER_CLASSES_3_IEP,
          NUMBER_CLASSES_4_IEP,
          NUMBER_CLASSES_5_IEP,
          NUMBER_CLASSES_6_IEP,
          NUMBER_CLASSES_7_PLUS_IEP,
         riding_code) %>% 
  group_by(riding_code) %>% 
  summarise(`+3 IEPs` = sum(NUMBER_CLASSES_3_IEP,
                            NUMBER_CLASSES_4_IEP,
                            NUMBER_CLASSES_5_IEP,
                            NUMBER_CLASSES_6_IEP,
                            NUMBER_CLASSES_7_PLUS_IEP)) %>%
  drop_na() %>% 
  full_join(BC_data, by = "riding_code")

IEP <- ggplot(IEPex1, aes(x = long, y = lat, group = group, fill = `+3 IEPs`)) +
  geom_polygon() +
  coord_fixed() +
  theme_mapcan() +
  # labs(title = "") +
  scale_fill_continuous(name = "Total Classes with >=3 Students with IEPs")

# plotly::ggplotly(IEP)
renderPlotly(IEP)

```
##Comment from Ping for the IEP in BC interactive map
##1. As someone who is not familiar with the geography of British Columbia. I would recommend you putting the name of each district along with the tag showing the amount of classrooms with at least three IEP students.
##2. You may use a different color pallette that has centered color. This would help the audience indicates easier if any area has high density, compared to average amount of the classrooms with IEP students.
##3. You may make the header bigger and more eye-catching.
##4. Moving the legend to the bottom and make it horizontal 


English Learners in BC
=============================

Column {data-width=350}
-----------------------------------------------------------------------

### Number of K-12 Classes with at least One Student Designated as an English Learner by District in BC

This is another interactive figure which indicates the amount of classrooms in each district that are composed of at least one student who is identified as an English Learner. This is important because the combination of English Learners and students with individualized needs frequently triggers additional supports to be put in place for classroom teachers to make accommodations and modifications for all students who may require additional support.. Future iterations of this figure may demonstrate
this relationship over time for the province of BC.

```{r ELexample}

ELex1 <- districting %>% 
  filter(SCHOOL_YEAR == "2020") %>% 
  select(NUMBER_CLASSES_1_ELL,
         NUMBER_CLASSES_2_ELL,
         NUMBER_CLASSES_3_ELL,
         NUMBER_CLASSES_4_ELL,
         NUMBER_CLASSES_5_ELL,
         NUMBER_CLASSES_6_ELL,
         NUMBER_CLASSES_7_PLUS_ELL,
         riding_code) %>%
  group_by(riding_code) %>%
  summarise(`+1 ELs` = sum( NUMBER_CLASSES_1_ELL, 
                            NUMBER_CLASSES_2_ELL,
                            NUMBER_CLASSES_3_ELL,
                            NUMBER_CLASSES_4_ELL,
                            NUMBER_CLASSES_5_ELL,
                            NUMBER_CLASSES_6_ELL,
                            NUMBER_CLASSES_7_PLUS_ELL)) %>%
  drop_na() %>%
  full_join(BC_data, by = "riding_code") 

EL <- ggplot(ELex1, aes(x = long, y = lat, group = group, fill = `+1 ELs`)) +
  geom_polygon() +
  coord_fixed() +
  theme_mapcan() +
  scale_fill_continuous(name = "Total Classes with >1 Student Learning English")

renderPlotly(EL)
# plotly::ggplotly(EL)


```
##Comments from Ping about the English learner graph.
##1. The same comments about legend, title, and the distric names would be the same with the above graph.
##2. I can barely see the disticts that has > 6000 ELs. I think there are a couple ways that may enhance the visibility. First, you might try reversing the order (i.e., the districts with > 6000 ELs become dark blue and those with < 2000 become light blue). Second, you might find a way to create a new sided-window that enlarge those districts (just like what we usually see on the printed maps).

EL Prevalence in Classrooms over Time
=============================

Column {data-width=350}
-----------------------------------------------------------------------

### Longitudinal

I would like to make this an interactive figure by populating the district name & number of students when your mouse rolls over the spot on the figure. I've highlighted three examples, similar to our lab 3, as an example. \n\n\n

```{r EL_time}

Plot_Longitudinal <- districting %>% 
  mutate(SCHOOL_YEAR = as.numeric(SCHOOL_YEAR),
          totalELs = NUMBER_CLASSES_1_ELL+
           NUMBER_CLASSES_2_ELL +
           NUMBER_CLASSES_3_ELL +
           NUMBER_CLASSES_4_ELL +
           NUMBER_CLASSES_5_ELL +
           NUMBER_CLASSES_6_ELL +
           NUMBER_CLASSES_7_PLUS_ELL)

ggplot(Plot_Longitudinal, aes(SCHOOL_YEAR, totalELs))+
  geom_line(aes(group = DISTRICT_NAME),
            color = "gray75") +
  geom_line(data = filter(Plot_Longitudinal,
      DISTRICT_NAME == "Surrey"),
           color = "#60D838") +
  geom_line(data = filter(Plot_Longitudinal,
      DISTRICT_NAME == "Vancouver"),
      color = "#ff00e6") +
  geom_line(data = filter(Plot_Longitudinal,
      DISTRICT_NAME == "Greater Victoria"),
           color = "#0004ff") +
  theme_minimal() +
  labs(title = "Classrooms with +1 ELs by School District") +
       xlab("School Year") +
       ylab("Number of Clasrooms with +1 EL Student") +
    annotate(geom = "text", x = 2015, y = 5500, label = "Surrey", hjust = "left") +
    annotate(geom = "text", x = 2008, y = 5650, label = "Vancouver", hjust = "left") +
    annotate(geom = "text", x = 2012, y = 1311, label = "Victoria", hjust = "left")

```
##Comments from Ping about the graph for EL prevalence in classroom overtime.
##1. I'm not sure if you've noticed that the ggplot is overlaying your content.
##2. As you mentioned above that you wanna make this interactive. I think it would be a good idea to make those non-highlight lines turn into color when you 
